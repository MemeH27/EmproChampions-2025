<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Partido</title>
  <link rel="stylesheet" href="styles/control.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, push } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD9cpSfGG212h80iXofJetw-B-arEEcOvI",
      authDomain: "emprochampions2025.firebaseapp.com",
      projectId: "emprochampions2025",
      storageBucket: "emprochampions2025.appspot.com",
      messagingSenderId: "683206087538",
      appId: "1:683206087538:web:8a1473aec968bd6ab543eb",
      measurementId: "G-3TX5J3NDT5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const equipo1 = JSON.parse(localStorage.getItem("equipo1"));
    const equipo2 = JSON.parse(localStorage.getItem("equipo2"));
    const genero = localStorage.getItem("genero") || "masculino";

    let goles1 = 0, goles2 = 0;
    let tiempo = 0;
    let intervalo = null;
    let enJuego = false;
    let partidoFinalizado = false;
    let estabaJugando = false;
    let equipoActual = 0;
    const goleadores = [];

    window.iniciar = () => {
      if (intervalo || partidoFinalizado) return;
      intervalo = setInterval(() => {
        tiempo++;
        actualizarCrono();
      }, 1000);
      enJuego = true;
    };

    window.pausar = () => {
      if (partidoFinalizado) return;
      clearInterval(intervalo);
      intervalo = null;
      enJuego = false;
    };

    window.reiniciar = () => {
      if (partidoFinalizado) return;
      pausar();
      tiempo = 0;
      actualizarCrono();
    };

    window.gol = (equipo) => {
      if (!enJuego || partidoFinalizado) {
        alert("â›” El cronÃ³metro estÃ¡ pausado o el partido ha finalizado");
        return;
      }
      equipoActual = equipo;
      estabaJugando = enJuego;
      pausar();
      document.getElementById("modalGoleador").style.display = "flex";
    };

    window.guardarGol = () => {
      const nombre = document.getElementById("goleador").value.trim();
      if (!nombre) return alert("âš ï¸ EscribÃ­ el nombre del goleador");

      if (equipoActual === 1) goles1++;
      else goles2++;

      goleadores.push({ equipo: equipoActual, nombre });

      document.getElementById("modalGoleador").style.display = "none";
      document.getElementById("goleador").value = "";
      actualizarMarcador();
      if (estabaJugando) iniciar();
    };

    function actualizarMarcador() {
      document.getElementById("marcador").textContent = `${goles1} : ${goles2}`;
    }

    function actualizarCrono() {
      const min = String(Math.floor(tiempo / 60)).padStart(2, '0');
      const seg = String(tiempo % 60).padStart(2, '0');
      document.getElementById("cronometro").textContent = `${min}:${seg}`;
    }

    window.finalizarPartido = async () => {
      if (!enJuego || partidoFinalizado) {
        alert("â›” El partido no estÃ¡ en juego.");
        return;
      }
      pausar();
      partidoFinalizado = true;

      const historialRef = ref(db, "historialPartidos");
      const nuevoHistorial = {
        fecha: new Date().toLocaleString(),
        genero,
        equipo1: equipo1.name,
        equipo2: equipo2.name,
        marcador: `${goles1} - ${goles2}`,
        tiempo: `${String(Math.floor(tiempo / 60)).padStart(2, '0')}:${String(tiempo % 60).padStart(2, '0')}`
      };
      await push(historialRef, nuevoHistorial);

      alert("âœ… Partido finalizado y registrado correctamente.");
      window.location.href = "index.html";
    };

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("logo1").src = equipo1.logo;
      document.getElementById("logo2").src = equipo2.logo;
      document.getElementById("btnGol1").innerText = `âš½ Gol ${equipo1.name}`;
      document.getElementById("btnGol2").innerText = `âš½ Gol ${equipo2.name}`;
      actualizarCrono();
      actualizarMarcador();
    });
  </script>
</head>
<body>
<nav>
  <a href="match.html">ğŸ® Nuevo Partido</a>
  <a href="index.html">ğŸ“Š Tabla</a>
  <a href="goleadores.html">ğŸ¥‡ MÃ¡ximo Goleador</a>
  <a href="historial.html">ğŸ“‹ Historial de Partidos</a>
</nav>
<h1>PARTIDO EN JUEGO</h1>
<div class="match-container">
  <div class="shield"><img id="logo1" src=""></div>
  <div class="marcador" id="marcador">0 : 0</div>
  <div class="shield"><img id="logo2" src=""></div>
</div>
<div class="cronometro" id="cronometro">00:00</div>
<div class="botones">
  <div class="botones-row">
    <button class="btn-control" onclick="iniciar()">â–¶ Iniciar</button>
    <button class="btn-control" onclick="pausar()">â¸ Pausar</button>
    <button class="btn-control" onclick="reiniciar()">ğŸ” Reiniciar</button>
  </div>
  <div class="botones-row">
    <button id="btnGol1" class="btn-gol" onclick="gol(1)">âš½ Gol</button>
    <button id="btnGol2" class="btn-gol" onclick="gol(2)">âš½ Gol</button>
  </div>
  <button class="btn-finalizar" onclick="finalizarPartido()">ğŸ›‘ Finalizar Partido</button>
</div>
<div class="modal" id="modalGoleador">
  <div class="modal-content">
    <h3>Â¿QuiÃ©n anotÃ³ el gol?</h3>
    <input type="text" id="goleador" placeholder="Nombre del jugador">
    <button onclick="guardarGol()">Registrar</button>
  </div>
</div>
<canvas id="confetti" class="confetti"></canvas>
<audio id="golSound" src="GOL.mp3" preload="auto"></audio>
</body>
</html>