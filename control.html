<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Partido</title>
  <link rel="stylesheet" href="styles/control.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<nav>
  <a href="match.html">🎮 Nuevo Partido</a>
  <a href="index.html">📊 Tabla</a>
  <a href="goleadores.html">🥇 Máximo Goleador</a>
  <a href="historial.html">📋 Historial de Partidos</a>
</nav>

<h1>PARTIDO EN JUEGO</h1>

<div class="match-container">
  <div class="shield"><img id="logo1" src=""></div>
  <div class="marcador" id="marcador">0 : 0</div>
  <div class="shield"><img id="logo2" src=""></div>
</div>

<div class="cronometro" id="cronometro">00:00</div>

<div class="botones">
  <div class="botones-row">
    <button class="btn-control" onclick="iniciar()">▶ Iniciar</button>
    <button class="btn-control" onclick="pausar()">⏸ Pausar</button>
    <button class="btn-control" onclick="reiniciar()">🔁 Reiniciar</button>
  </div>

  <div class="botones-row">
    <button id="btnGol1" class="btn-gol" onclick="gol(1)">⚽ Gol</button>
    <button id="btnGol2" class="btn-gol" onclick="gol(2)">⚽ Gol</button>
  </div>

  <button class="btn-finalizar" onclick="finalizarPartido()">🛑 Finalizar Partido</button>
</div>

<div class="modal" id="modalGoleador">
  <div class="modal-content">
    <h3>¿Quién anotó el gol?</h3>
    <input type="text" id="goleador" placeholder="Nombre del jugador">
    <button onclick="guardarGol()">Registrar</button>
  </div>
</div>

<canvas id="confetti" class="confetti"></canvas>

<script>
  const equipo1 = JSON.parse(localStorage.getItem("equipo1"));
  const equipo2 = JSON.parse(localStorage.getItem("equipo2"));
  const genero = localStorage.getItem("genero") || "masculino";

  document.getElementById("logo1").src = equipo1.logo;
  document.getElementById("logo2").src = equipo2.logo;
  document.getElementById("btnGol1").innerText = `⚽ Gol ${equipo1.name}`;
  document.getElementById("btnGol2").innerText = `⚽ Gol ${equipo2.name}`;

  let goles1 = 0, goles2 = 0;
  let tiempo = 0;
  let intervalo = null;
  let enJuego = false;
  let estabaJugando = false;
  let equipoActual = 0;
  let partidoFinalizado = false;
  const goleadores = [];

  function actualizarCrono() {
    const min = String(Math.floor(tiempo / 60)).padStart(2, '0');
    const seg = String(tiempo % 60).padStart(2, '0');
    document.getElementById("cronometro").textContent = `${min}:${seg}`;
  }

  function actualizarMarcador() {
    document.getElementById("marcador").textContent = `${goles1} : ${goles2}`;
  }

  function iniciar() {
    if (intervalo || partidoFinalizado) return;
    intervalo = setInterval(() => {
      tiempo++;
      actualizarCrono();
    }, 1000);
    enJuego = true;
  }

  function pausar() {
    if (partidoFinalizado) return;
    clearInterval(intervalo);
    intervalo = null;
    enJuego = false;
  }

  function reiniciar() {
    if (partidoFinalizado) return;
    pausar();
    tiempo = 0;
    actualizarCrono();
  }

  function gol(equipo) {
    if (!enJuego || partidoFinalizado) {
      alert("⛔ El cronómetro está pausado o el partido ha finalizado");
      return;
    }
    equipoActual = equipo;
    estabaJugando = enJuego;
    pausar();
    document.getElementById("modalGoleador").style.display = "flex";
  }
function guardarGol() {
  const nombre = document.getElementById("goleador").value.trim();
  if (!nombre) return alert("⚠️ Escribí el nombre del goleador");

  if (equipoActual === 1) goles1++;
  else goles2++;

  goleadores.push({ equipo: equipoActual, nombre });

  actualizarMarcador();
  document.getElementById("modalGoleador").style.display = "none";
  document.getElementById("goleador").value = "";
  lanzarConfeti();
  document.getElementById("golSound").play();
  if (estabaJugando) iniciar();

  // 🔥 NUEVO: Guardar detalle con género
  const detalles = JSON.parse(localStorage.getItem("goleadoresDetalles")) || {};
  if (!detalles[nombre]) detalles[nombre] = [];
  detalles[nombre].push({
    fecha: new Date().toLocaleString(),
    equipo1: equipo1.name,
    equipo2: equipo2.name,
    minuto: `${String(Math.floor(tiempo / 60)).padStart(2, '0')}:${String(tiempo % 60).padStart(2, '0')}`,
    genero: genero
  });
  localStorage.setItem("goleadoresDetalles", JSON.stringify(detalles));
}


  function finalizarPartido() {
    if (!enJuego || partidoFinalizado) {
      alert("⛔ El partido no está en juego.");
      return;
    }
    pausar();
    partidoFinalizado = true;

    // Registrar en posiciones
    const key = genero === "femenino" ? "posicionesFemenino" : "posicionesMasculino";
    const posiciones = JSON.parse(localStorage.getItem(key)) || {};

    [equipo1.name, equipo2.name].forEach(name => {
      if (!posiciones[name]) {
        posiciones[name] = { PJ:0, G:0, E:0, P:0, GF:0, GC:0, Pts:0 };
      }
    });

    posiciones[equipo1.name].PJ++;
    posiciones[equipo2.name].PJ++;
    posiciones[equipo1.name].GF += goles1;
    posiciones[equipo1.name].GC += goles2;
    posiciones[equipo2.name].GF += goles2;
    posiciones[equipo2.name].GC += goles1;

    if (goles1 > goles2) {
      posiciones[equipo1.name].G++;
      posiciones[equipo1.name].Pts += 3;
      posiciones[equipo2.name].P++;
    } else if (goles2 > goles1) {
      posiciones[equipo2.name].G++;
      posiciones[equipo2.name].Pts += 3;
      posiciones[equipo1.name].P++;
    } else {
      posiciones[equipo1.name].E++;
      posiciones[equipo2.name].E++;
      posiciones[equipo1.name].Pts += 1;
      posiciones[equipo2.name].Pts += 1;
    }

    localStorage.setItem(key, JSON.stringify(posiciones));

    // Historial
    const historial = JSON.parse(localStorage.getItem("historialPartidos")) || [];
    historial.unshift({
      fecha: new Date().toLocaleString(),
      genero,
      equipo1: equipo1.name,
      equipo2: equipo2.name,
      marcador: `${goles1} - ${goles2}`,
      tiempo
    });
    localStorage.setItem("historialPartidos", JSON.stringify(historial));

    // Goleadores
    const tablaG = JSON.parse(localStorage.getItem("goleadores")) || {};
    goleadores.forEach(({ nombre }) => {
      if (!tablaG[nombre]) tablaG[nombre] = 0;
      tablaG[nombre]++;
    });
    localStorage.setItem("goleadores", JSON.stringify(tablaG));

    alert("✅ Partido finalizado y registrado correctamente.");
    window.location.href = "index.html";
  }

  function lanzarConfeti() {
    const duration = 2 * 1000;
    const end = Date.now() + duration;
    const colors = ['#FFD700', '#FFFFFF', '#FF69B4'];
    const canvas = document.getElementById("confetti");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const confettis = [];
    document.getElementById("golSound").play();


    for (let i = 0; i < 150; i++) {
      confettis.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height,
        r: Math.random() * 6 + 2,
        d: Math.random() * 10 + 2,
        color: colors[Math.floor(Math.random() * colors.length)],
        tilt: Math.random() * 10 - 10
      });
    }

    const interval = setInterval(() => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      confettis.forEach(c => {
        c.y += c.d;
        c.tilt += Math.random() * 0.2 - 0.1;
        ctx.beginPath();
        ctx.arc(c.x + c.tilt, c.y, c.r, 0, Math.PI * 2);
        ctx.fillStyle = c.color;
        ctx.fill();
      });
      if (Date.now() > end) {
        clearInterval(interval);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }, 16);
  }

  // Prevención de cierre o recarga
  window.addEventListener('beforeunload', function (e) {
    if (enJuego && !partidoFinalizado) {
      e.preventDefault();
      e.returnValue = '⚠️ Hay un partido en curso. ¿Estás seguro?';
      return '⚠️ Hay un partido en curso. ¿Estás seguro?';
    }
  });

  window.addEventListener('keydown', function(e) {
    if ((e.key === "F5" || e.key === "Backspace") && enJuego && !partidoFinalizado) {
      e.preventDefault();
    }
  });

  actualizarCrono();
  actualizarMarcador();
</script>
<audio id="golSound" src="GOL.mp3" preload="auto"></audio>

</body>
</html>

