<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Partido</title>
  <link rel="stylesheet" href="styles/control.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, push, update } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD9cpSfGG212h80iXofJetw-B-arEEcOvI",
      authDomain: "emprochampions2025.firebaseapp.com",
      projectId: "emprochampions2025",
      storageBucket: "emprochampions2025.appspot.com",
      messagingSenderId: "683206087538",
      appId: "1:683206087538:web:8a1473aec968bd6ab543eb",
      measurementId: "G-3TX5J3NDT5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Datos del partido
    const equipo1 = JSON.parse(localStorage.getItem("equipo1"));
    const equipo2 = JSON.parse(localStorage.getItem("equipo2"));
    const genero = localStorage.getItem("genero") || "masculino";

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("logo1").src = equipo1.logo;
      document.getElementById("logo2").src = equipo2.logo;
      document.getElementById("btnGol1").innerText = `‚öΩ Gol ${equipo1.name}`;
      document.getElementById("btnGol2").innerText = `‚öΩ Gol ${equipo2.name}`;
    });

    let goles1 = 0, goles2 = 0;
    let tiempo = 0;
    let intervalo = null;
    let enJuego = false;
    let partidoFinalizado = false;
    let estabaJugando = false;
    let equipoActual = 0;
    const goleadores = [];

    window.iniciar = () => {
      if (intervalo || partidoFinalizado) return;
      intervalo = setInterval(() => {
        tiempo++;
        actualizarCrono();
      }, 1000);
      enJuego = true;
    };

    window.pausar = () => {
      if (partidoFinalizado) return;
      clearInterval(intervalo);
      intervalo = null;
      enJuego = false;
    };

    window.reiniciar = () => {
      if (partidoFinalizado) return;
      pausar();
      tiempo = 0;
      actualizarCrono();
    };

    window.gol = (equipo) => {
      if (!enJuego || partidoFinalizado) {
        alert("‚õî El cron√≥metro est√° pausado o el partido ha finalizado");
        return;
      }
      equipoActual = equipo;
      estabaJugando = enJuego;
      pausar();
      document.getElementById("modalGoleador").style.display = "flex";
    };

    window.guardarGol = () => {
      const nombre = document.getElementById("goleador").value.trim();
      if (!nombre) return alert("‚ö†Ô∏è Escrib√≠ el nombre del goleador");

      if (equipoActual === 1) goles1++;
      else goles2++;

      goleadores.push({ equipo: equipoActual, nombre });

      document.getElementById("modalGoleador").style.display = "none";
      document.getElementById("goleador").value = "";
      actualizarMarcador();
      lanzarConfeti();
      document.getElementById("golSound").play();
      if (estabaJugando) iniciar();
    };

    function actualizarMarcador() {
      document.getElementById("marcador").textContent = `${goles1} : ${goles2}`;
    }

    function actualizarCrono() {
      const min = String(Math.floor(tiempo / 60)).padStart(2, '0');
      const seg = String(tiempo % 60).padStart(2, '0');
      document.getElementById("cronometro").textContent = `${min}:${seg}`;
    }

    window.finalizarPartido = async () => {
      if (!enJuego || partidoFinalizado) {
        alert("‚õî El partido no est√° en juego.");
        return;
      }
      pausar();
      partidoFinalizado = true;

      const posicionesRef = ref(db, genero === "femenino" ? "posicionesFemenino" : "posicionesMasculino");
      const posicionesSnap = await get(posicionesRef);
      const posiciones = posicionesSnap.val() || {};

      [equipo1.name, equipo2.name].forEach(name => {
        if (!posiciones[name]) {
          posiciones[name] = { PJ:0, G:0, E:0, P:0, GF:0, GC:0, Pts:0 };
        }
      });

      posiciones[equipo1.name].PJ++;
      posiciones[equipo2.name].PJ++;
      posiciones[equipo1.name].GF += goles1;
      posiciones[equipo1.name].GC += goles2;
      posiciones[equipo2.name].GF += goles2;
      posiciones[equipo2.name].GC += goles1;

      if (goles1 > goles2) {
        posiciones[equipo1.name].G++;
        posiciones[equipo1.name].Pts += 3;
        posiciones[equipo2.name].P++;
      } else if (goles2 > goles1) {
        posiciones[equipo2.name].G++;
        posiciones[equipo2.name].Pts += 3;
        posiciones[equipo1.name].P++;
      } else {
        posiciones[equipo1.name].E++;
        posiciones[equipo2.name].E++;
        posiciones[equipo1.name].Pts += 1;
        posiciones[equipo2.name].Pts += 1;
      }

      await set(posicionesRef, posiciones);

      // Guardar historial
      const historialRef = ref(db, "historialPartidos");
      const nuevoHistorial = {
        fecha: new Date().toLocaleString(),
        genero,
        equipo1: equipo1.name,
        equipo2: equipo2.name,
        marcador: `${goles1} - ${goles2}`,
        tiempo: `${String(Math.floor(tiempo / 60)).padStart(2, '0')}:${String(tiempo % 60).padStart(2, '0')}`
      };
      await push(historialRef, nuevoHistorial);

      // Tabla de goleadores
      const tablaRef = ref(db, "goleadores");
      const detallesRef = ref(db, "goleadoresDetalles");

      for (const g of goleadores) {
        const nombre = g.nombre;
        const detalle = {
          fecha: new Date().toLocaleString(),
          equipo1: equipo1.name,
          equipo2: equipo2.name,
          minuto: `${String(Math.floor(tiempo / 60)).padStart(2, '0')}:${String(tiempo % 60).padStart(2, '0')}`,
          genero: genero
        };

        // Incrementar contador
        const contRef = ref(db, `goleadores/${nombre}`);
        const contSnap = await get(contRef);
        const actual = contSnap.val() || 0;
        await set(contRef, actual + 1);

        // Agregar detalle
        const detalleRef = ref(db, `goleadoresDetalles/${nombre}`);
        const detalleSnap = await get(detalleRef);
        const lista = detalleSnap.val() || [];
        lista.push(detalle);
        await set(detalleRef, lista);
      }

      alert("‚úÖ Partido finalizado y registrado correctamente.");
      window.location.href = "index.html";
    };

    function lanzarConfeti() {
      const duration = 2 * 1000;
      const end = Date.now() + duration;
      const colors = ['#FFD700', '#FFFFFF', '#FF69B4'];
      const canvas = document.getElementById("confetti");
      const ctx = canvas.getContext("2d");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const confettis = [];

      for (let i = 0; i < 150; i++) {
        confettis.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          r: Math.random() * 6 + 2,
          d: Math.random() * 10 + 2,
          color: colors[Math.floor(Math.random() * colors.length)],
          tilt: Math.random() * 10 - 10
        });
      }

      const interval = setInterval(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        confettis.forEach(c => {
          c.y += c.d;
          c.tilt += Math.random() * 0.2 - 0.1;
          ctx.beginPath();
          ctx.arc(c.x + c.tilt, c.y, c.r, 0, Math.PI * 2);
          ctx.fillStyle = c.color;
          ctx.fill();
        });
        if (Date.now() > end) {
          clearInterval(interval);
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }, 16);
    }

    window.addEventListener('beforeunload', function (e) {
      if (enJuego && !partidoFinalizado) {
        e.preventDefault();
        e.returnValue = '‚ö†Ô∏è Hay un partido en curso. ¬øEst√°s seguro?';
      }
    });

    window.addEventListener('keydown', function(e) {
      if ((e.key === "F5" || e.key === "Backspace") && enJuego && !partidoFinalizado) {
        e.preventDefault();
      }
    });

  </script>
</head>
<body>

<nav>
  <a href="match.html">üéÆ Nuevo Partido</a>
  <a href="index.html">üìä Tabla</a>
  <a href="goleadores.html">ü•á M√°ximo Goleador</a>
  <a href="historial.html">üìã Historial de Partidos</a>
</nav>

<h1>PARTIDO EN JUEGO</h1>

<div class="match-container">
  <div class="shield"><img id="logo1" src=""></div>
  <div class="marcador" id="marcador">0 : 0</div>
  <div class="shield"><img id="logo2" src=""></div>
</div>

<div class="cronometro" id="cronometro">00:00</div>

<div class="botones">
  <div class="botones-row">
    <button class="btn-control" onclick="iniciar()">‚ñ∂ Iniciar</button>
    <button class="btn-control" onclick="pausar()">‚è∏ Pausar</button>
    <button class="btn-control" onclick="reiniciar()">üîÅ Reiniciar</button>
  </div>

  <div class="botones-row">
    <button id="btnGol1" class="btn-gol" onclick="gol(1)">‚öΩ Gol</button>
    <button id="btnGol2" class="btn-gol" onclick="gol(2)">‚öΩ Gol</button>
  </div>

  <button class="btn-finalizar" onclick="finalizarPartido()">üõë Finalizar Partido</button>
</div>

<div class="modal" id="modalGoleador">
  <div class="modal-content">
    <h3>¬øQui√©n anot√≥ el gol?</h3>
    <input type="text" id="goleador" placeholder="Nombre del jugador">
    <button onclick="guardarGol()">Registrar</button>
  </div>
</div>

<audio id="golSound" src="GOL.mp3" preload="auto"></audio>
<canvas id="confetti" class="confetti"></canvas>

</body>
</html>
